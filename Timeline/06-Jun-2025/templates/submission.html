{% extends "topNav.html" %} {% block title %}Submission{% endblock %}

{% block submission_active %}active{% endblock %} {% block main-content %}

{% block Head %}

<style>
    /* tree styles */
    .tree {
        list-style-type: none;
        padding-left: 20px;
    }

    .tree li {
        margin: 5px 0;
    }

    .tree li span.toggle {
        cursor: pointer;
    }

    .tree .children {
        display: none;
        list-style-type: none;
        padding-left: 20px;
    }

    /* main tablestle.milestoneRow, */
    .taskRow {
        display: none;
    }

    /* date change on card header */
    .arrows:hover {
        background-color: rgb(170, 168, 168);
    }

    .blink {
        animation: blinker 1s step-start infinite;
    }

    @keyframes blinker {
        50% {
            opacity: 0;
        }
    }

    .table-responsive {
        max-height: 70.5dvh;
    }

    .modalTable {
        max-height: 70.5dvh;
        overflow-y: auto;
    }

    @media (max-width: 1366px) {
        .table-responsive {
            max-height: 70dvh;
        }

        .modalTable {
            max-height: 60dvh;
            overflow-y: auto;
        }
    }

    @media (min-width: 1367px) and (max-width: 1600px) {
        .table-responsive {
            max-height: 71dvh;
        }

        .modalTable {
            max-height: 71dvh;
            overflow-y: auto;
        }
    }
</style>
{% load static %}
<link rel="stylesheet" href="{% static 'css/select2.min.css'%}">
{% endblock %}

<div class="card">
    <!-- <div class="col-2 d-flex justify-content-start align-items-center">
            <strong id="currentdate"></strong>
        </div> -->
    <div class="card-header d-flex justify-content-between align-items-center text-nowrap">
        <div class="col-1 headerbuttons"><button id="jobAssignButton" type="button"
                class="form-control assignButtons px-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-plus-circle" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                    <path
                        d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                </svg>
                Jobs:</button></div>
        <div class="col-1 headerbuttons"><button id="ServicesassignButton" class="form-control assignButtons px-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-plus-circle" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                    <path
                        d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                </svg>
                Job Undefined</button></div>
        <div class="col-1 headerbuttons"><button id="assignButton" class="form-control px-0 assignButtons">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-plus-circle" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                    <path
                        d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                </svg>
                Task Undefined</button></div>

        <div class="col-5 d-flex justify-content-center align-items-center">
            <strong id="currentWeek" class="me-2"></strong>
            <div class="vr mx-3"></div>
            <div>
                <button class="form-control left_arrow arrows" style="border-radius: 50%;" type="button"><i
                        class="fas fa-angle-left"></i></button>
            </div>
            <strong id="fromdate" class="mb-0 mx-2"></strong><strong>-</strong><strong id="todate"
                class="mb-0 mx-2"></strong>
            <div>
                <button class="form-control right_arrow arrows" style="border-radius: 50%;" type="button"><i
                        class="fas fa-angle-right"></i></button>
            </div>
        </div>

        <div class="col-1 headerbuttons"><button class="form-control bg-info px-0" id="unlock"> Unlock</button></div>

        <div class="col-1 headerbuttons"><button class="form-control bg-info px-0" id="duplicateButton">
                Extend Tasks</button></div>
        <div class="col-1 headerbuttons"><button class="form-control bg-info px-0" data-bs-toggle="modal"
                data-bs-target="#preview" id="previewBtn">Preview</button></div>
    </div>
    <div class="card-body ">
        <div class="table-responsive">
            <table class="table table-sm table-striped table-hover my-0 text-nowrap position-relative"
                id="projectTable"></table>
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-striped table-hover my-0 text-nowrap position-relative"
                id="nonProjectTable"></table>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center ">
        <div class="col-6 text-primary">
            <label class="text-info">* The entry hours should be formatted as "hh.mm".</label>
            <div class="vr mx-3"></div>
            <label>** Budget Owner : The person who assigned the task.</label>
        </div>
        <div class="col-4 d-flex justify-content-end align-items-center ">
            <div id="statusDiv">
                <label class="text-primary">Status :</label>
                <strong id="statusField"></strong>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" id="showRejectionReason"
                    fill="currentColor" class="bi bi-info-circle text-info" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                    <path
                        d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0" />
                </svg>
            </div>
            <div class="vr mx-3"></div>
            <div>
                <label class="text-primary">Estimated Hours :</label>
                <strong id="estimated_hrs" class="text-primary"></strong>
            </div>
            <div class="vr mx-3"></div>
            <div>
                <label>Actual Hours :</label>
                <strong id="actualhours"></strong>
            </div>

        </div>

    </div>
</div>

<!-- Project assign model(sales,project Execution) -->
<div class="modal fade" id="projectassignModal" aria-labelledby="assign_project_modal" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Assign Job No</h5>
                <button type="button" class="btn-close modalCancelButton" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center gap-2 mb-3">
                    <input type="text" class="form-control w-100 w-md-auto" id="searchInput" placeholder="Search ....">
                    <label class="form-group border-lable-flt w-100 w-md-auto">
                        <select class="form-control w-100 w-md-auto" id="phaseSelect">
                            <option value="Sales">Sales</option>
                            <option value="ProjectExecution" selected>Project Execution</option>
                            <option value="SiteServices">Site Services</option>
                        </select><span>Service</span>
                    </label>
                </div>
                <hr>
                <div id="assignProjectTable">
                    <div class="modalTable mt-2">
                        <table class="table table-hover table-sm table table-striped" id="assignProjectsTable">
                            <thead>
                                <!-- <th class="text-end px-0"><input type="checkbox" id="Assign" class="allselect m-0"></th>  
                                <th>Select All</th> -->
                                <th class="text-center px-0">#</th>
                                <th>Jobs:</th>
                                <!-- <th>Date</th>
                                <th>Customer Name</th>
                                <th>Project Name</th> -->
                            </thead>
                        </table>
                    </div>
                    <div class="row justify-content-end">
                        <div class="col-3">
                            <button type="submit" class="form-control projectassign_submit bg-info">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Project assign model(for create undefined service) -->
<div class="modal fade" id="serviceAssignModal" aria-labelledby="assign_service_modal" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Assign Undefined Jobs</h5>
                <button type="button" class="btn-close modalCancelButton" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="assignProjectUndefined">
                    <form id="undefinedQuotationForm" autocomplete="off">

                        <div class="form-outline mb-3">
                            <input type="text" class="form-control" id="undefinedprojectName"
                                name="undefinedprojectName" required>
                            <label class="form-label" for="undefinedprojectName">Project Name</label>
                        </div>
                        <div class="form-outline mb-3">
                            <input type="text" class="form-control" id="undefinedcustomerName"
                                name="undefinedcustomerName" required>
                            <label class="form-label" for="undefinedcustomerName">Customer Name</label>
                        </div>
                        <div class="form-outline ">
                            <input type="text" class="form-control" id="undefinedjobNo" name="undefinedjobNo">
                            <label class="form-label " for="undefinedjobNo">Job Number</label>
                        </div>
                        <div class="mb-3"><small for="Remarks" class="text-danger">* job Number is applicable only for
                                US team, Others must leave this as blank.</small></div>
                        <div class="row justify-content-end">
                            <div class="col-3">
                                <button type="submit" class="form-control bg-info"
                                    id="undefinedQuotationSubmit">Submit</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assign task model -->
<div class="modal fade" id="assignModal" aria-labelledby="assign_modal" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Assign Tasks</h5>
                <button type="button" class="btn-close cancelButton" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- <label class="text-danger">*<span class="blink text-danger">Please select tasks from the list</span></label> -->
                <div class="modalTable">
                    <ul class="tree list-group list-group-flush p-0 m-0" id="menu-tree">
                        <!-- Menu tree will be loaded here via AJAX -->
                    </ul>
                </div>
                <div class="row justify-content-end">
                    <div class="col-3">
                        <button type="submit" id="assignMilestoneBtn" class="form-control bg-info">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview -->
<div class="modal fade" id="preview" tabindex="-1" aria-labelledby="preview_Modal" aria-hidden="true">
    <div class="modal-dialog  modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header ">
                <h5 class="modal-title" id="exampleModalLabel">Total Work Hours</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-hover table-sm table-responsive table-striped" id="previewtable">
                    <thead>
                        <th>Day</th>
                        <th>Hours</th>
                    </thead>
                </table>
                <div class="row justify-content-end">
                    <div class="col-5">
                        <button type="submit" class="form-control bg-info" id="submitButton">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- rejection reason modal -->
<div class="modal fade" id="rejectionReasonModal" tabindex="-1" aria-labelledby="rejectionReasonModal"
    aria-hidden="true">
    <div class="modal-dialog  modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header ">
                <h5 class="modal-title" id="exampleModalLabel">Rejection reasons Task Wise</h5>
                <button type="button" class="btn-close cancelButton" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-hover table-sm modalTable table-striped" id="rejectionReasonTbl">
                    <thead>
                        <th>Task</th>
                        <th>Rejection Reason</th>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- Unlock reason entering modal -->
<div class="modal fade" id="warningUnlockModal" tabindex="-1" role="dialog" data-bs-backdrop="static"
    data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-md" role="document">
        <div class="modal-content">
            <div class="modal-body text-center p-lg-4">
                <i class="bi bi-exclamation-triangle" style="color: rgb(235, 183, 15);font-size: 3rem;"></i>
                <h4 class="text-warning bold mt-1">Warning !</h4>
                <p class="mt-3" id="warningUnlockText"></p>
                <div class="form-outline">
                    <textarea type="text" class="form-control" id="unlockReason"></textarea>
                    <label class="form-label">Unlocking reason</label>
                </div>
                <small id="unlockModalError" class="text-danger"></small>
                <div class="row mt-3">
                    <div class="col">
                        <button type="button" class="btn btn-sm btn-dark w-100 cancelButton"
                            data-bs-dismiss="modal">Cancel</button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-sm btn-warning w-100" id="unlockModalBtn"
                            data-bs-dismiss="modal">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- common modals -->
{% include 'notifications.html' %}

<script>
    let expandedRows = {
        projectRows: new Set(),
        milestoneRows: new Set()
    };
    let previousCellValue = ""
    let noTaskQuotations = {}
    let assigners = []

    $(document).ready(function () {
        // get method
        function ajax_Get() {
            $.ajax({
                url: "{% url 'get_time_sheet_templete' %}",
                type: 'GET',
                success: function (response) {
                    load_data(response)
                },
                dataType: "json"
            });
        }
        ajax_Get();
        // post method
        function ajax_post(data) {
            $.ajax({
                url: "{% url 'get_time_sheet_templete' %}",
                type: 'POST',
                data: data,
                success: function (response) {
                    if (response.hasOwnProperty('status')) {
                        var message = response['status']
                        showMessage(message);
                    }
                    else {
                        if (data['mode'] == "removemilestone") {
                            var message = "Tasks removed successfully!"
                            showMessage(message, '#successText', '#successModal');
                        }
                        if (data['mode'] == "submit") {
                            var message = "Timesheet Submitted successfully!"
                            showMessage(message, '#successText', '#successModal');
                        }
                        if (data['mode'] == "assignmilestone") {
                            var message = "Tasks were successfully added!"
                            showMessage(message, '#successText', '#successModal');
                        }
                        load_data(response)
                    }
                }
            })
        }

        //post week
        $('.right_arrow').on("click", function () {
            // expandedRows.projectRows.clear();
            // expandedRows.milestoneRows.clear();
            var fromDate = $("#fromdate").text();
            ajax_post({ fromDate: fromDate, mode: "postdate" })
        })

        // pre week
        $('.left_arrow').on("click", function () {
            // expandedRows.projectRows.clear();
            // expandedRows.milestoneRows.clear();
            var fromDate = $("#fromdate").text();
            ajax_post({ fromDate: fromDate, mode: "predate" })
        })

        // ...........................assign project............................
        displayedDataList = [];
        // First step (job no: button) Project assign
        $('#jobAssignButton').on("click", function () {
            $('#projectassignModal').modal("show");
            ajax_projectassign("{% url 'fetch_quotations' %}")
        })

        document.getElementById('phaseSelect').addEventListener('change', function () {
            const selectedPhase = $('#phaseSelect').val(); // Get selected value
            filterTableRowsByPhase(selectedPhase);
        });

        function filterTableRowsByPhase(selectedPhase) {
            const rows = document.querySelectorAll('#assignProjectsTable .row_select');
            displayedDataList = [];

            rows.forEach(row => {
                const saleType = row.getAttribute('sale_type');
                const status = row.getAttribute('status');

                if (selectedPhase === 'Sales') {
                    row.style.display = '';
                } else if (selectedPhase === 'ProjectExecution') {
                    row.style.display = (status === 'Confirmed' && saleType !== 'SiteSupport') ? '' : 'none';
                } else {
                    row.style.display = (status === 'Confirmed' && saleType === 'SiteSupport') ? '' : 'none';
                }

                if (row.style.display !== 'none') {
                    displayedDataList.push(row);
                }
            });
        }


        function ajax_projectassign(url) {
            $.ajax({
                url: url,
                type: 'GET',
                success: function (response) {
                    // Clear previous rows except for the header
                    $('#assignProjectsTable tr').not(':first').remove(); // Keep the header

                    // Initialize the table body
                    let k = '<tbody>';

                    if (response.projectslist.length === 0) {
                        k += '<tr><td colspan="2" class="text-center text-info text-uppercase">No projects!</td></tr>';
                    } else {
                        // Create a set of assigned quotation numbers for quick lookup
                        const assignedQuotationsSet = new Set(response.assignedProjectList.map(value => value['quotation']));

                        $.each(response.projectslist, function (i, val) {
                            const isAssigned = assignedQuotationsSet.has(val['quotation_no']);

                            k += `
                                <tr class="row_select" id ="${val["id"]}"  quotation="${val['quotation_no']}" sale_type="${val['sale_type']}" status="${val['status']}" >
                                    <td class="text-end px-0">
                                        <input type="checkbox" class="p_checkbox" ${isAssigned ? 'checked' : ''} name ="${val["id"]}" />
                                    </td>
                                    <td>
                                        ${val['custom_project_name']
                                    ? `${val['quotation_no']} - ${val['customer_name']} - ${val['custom_project_name']} - ( Dated ${val['quote_date'].split('T')[0]} )`
                                    : val['project__name']
                                        ? `${val['quotation_no']} - ${val['customer_name']} - ${val['project__name']} - ( Dated ${val['quote_date'].split('T')[0]} )`
                                        : `${val['quotation_no']} - ${val['customer_name']} - ( Dated ${val['quote_date'].split('T')[0]} )`
                                }
                                    </td>
                                </tr>`;
                        });
                    }

                    k += '</tbody>';

                    // Append the generated HTML to the table
                    $('#assignProjectsTable').append(k);
                    const projectassignTblRows = document.querySelectorAll('#assignProjectsTable .row_select'); // Get all rows
                    displayedDataList = projectassignTblRows

                    const initialPhase = document.getElementById('phaseSelect').value;
                    if (initialPhase === 'ProjectExecution') {
                        filterTableRowsByPhase(initialPhase);
                    }

                }
            })
        }

        // First step Services Projects (job undefined button) assign
        $('#ServicesassignButton').on("click", function () {
            $('#serviceAssignModal').modal("show");
            // $('#assignServiceSelect').removeAttr('hidden');
            // $.ajax({
            //     url: "{% url 'fetchServiceMilestonesTasks' %}",
            //     type:'GET',
            //     success: function(response) {
            //         var menuTree = $('#serviceMilestone');
            //         // clear data from menutree
            //         menuTree.empty();
            //         response.serviceMilestoneList.forEach(function(milestone) {
            //         var milestoneItem = `
            //             <li class="list-group-item m-1 p-0">
            //                 <span class="toggle" onclick="toggleChildren('milestone-${milestone.milestone}', this)" style="cursor: pointer;" >[+]</span>
            //                 <input type="checkbox" id="select-all-milestone-${milestone.milestone}" onclick="selectAllChildren(this)" hidden >
            //                 <label for="select-all-milestone-${milestone.milestone}">${milestone.milestoneName}</label>
            //                 <ul class="children list-group list-group-flush m-0" id="milestone-${milestone.milestone}-children" style="display: none;" >
            //                     ${milestone.tasks.map(task => `
            //                         <li class="ms-4 p-0 list-group-item serviceMilestoneList">
            //                             <input type="checkbox" id="task-${task.task}" task='${task.task}' taskName='${task.taskName}' milestone='${milestone.milestone}' milestoneName='${milestone.milestoneName}'>
            //                             <label for="task-${task.task}">${task.taskName}</label>
            //                         </li>
            //                     `).join('')}
            //                 </ul>
            //             </li>`;
            //             menuTree.append(milestoneItem);
            //         })
            //     },
            //     dataType: "json"
            // });
        })

        $('#undefinedQuotationSubmit').on("click", function (event) {
            event.preventDefault();

            let undefinedProjectName = $('#undefinedprojectName').val().trim();
            const undefinedcustomerName = $('#undefinedcustomerName').val().trim();
            const undefinedjobNo = $('#undefinedjobNo').val().trim();
            const fromDate = $("#fromdate").text();

            // Validate project name
            if (undefinedProjectName === "") {
                return showMessage("Project Name is required");
            }

            // Validate customer name
            if (undefinedcustomerName === "") {
                return showMessage("Customer Name is required");
            }

            // Check for special characters in project name (allow letters, numbers, and spaces only)
            const validProjectNamePattern = /^[A-Za-z0-9 ]+$/;
            if (!validProjectNamePattern.test(undefinedProjectName)) {
                return showMessage("Project Name must contain only letters, numbers, and spaces (no special characters)");
            }

            // Append job number if available
            if (undefinedjobNo !== "") {
                undefinedProjectName = undefinedjobNo + '-' + undefinedProjectName;
            }

            undefinedProjectName = undefinedProjectName.toUpperCase();

            // Final check before sending AJAX

            $.ajax({
                url: "{% url 'assignUndefinedQuotation' %}",
                type: 'POST',
                data: {
                    checkedItems: JSON.stringify([]),
                    undefinedProjectName: undefinedProjectName,
                    fromDate: fromDate,
                    undefinedcustomerName: undefinedcustomerName
                },
                success: function (response) {
                    ajax_Get();
                    if (response.status === "ok") {
                        let message = 'Undefined Jobs were successfully added!';
                        showMessage(message, '#successText', '#successModal');
                    }
                }
            });

            $(".btn-close").click();
        });


        $('#undefinedQuotationSubmitold').on("click", function (event) {
            event.preventDefault();
            let undefinedProjectName = $('#undefinedprojectName').val();
            const undefinedcustomerName = $('#undefinedcustomerName').val();
            if (undefinedProjectName !== "")
                return showMessage("ProjctName is required",)
            if (undefinedcustomerName !== "")
                return showMessage("CustomerName is required",)

            const undefinedjobNo = $('#undefinedjobNo').val();
            if (undefinedjobNo !== "") {
                undefinedProjectName = undefinedProjectName + '-' + undefinedjobNo
            }


            if (undefinedProjectName !== "") {
                var fromDate = $("#fromdate").text();
                // var checkedItems = [];
                // // Get all selectedItems within the list
                // var selectedItems = document.querySelectorAll('.serviceMilestoneList input[type="checkbox"]');

                // // Loop through selectedItems
                // selectedItems.forEach(function(item) {
                //     if (item.checked) {
                //         checkedItems.push({
                //             milestone: parseInt(item.getAttribute('milestone')),
                //             milestoneName: item.getAttribute('milestoneName'),
                //             task: parseInt(item.getAttribute('task')),
                //             taskName: item.getAttribute('taskName')
                //         });
                //     }
                // });
                // let message = "Choose the tasks from the list. You cannot add tasks to this project after it has been submitted."
                // showMessage(message, '#warningText', '#warningModal');

                // $('.warningOkBtn').off('click');

                // $('.warningOkBtn').on('click',function(event){
                //     $('#warningModal').modal('hide')
                $.ajax({
                    url: "{% url 'assignUndefinedQuotation' %}",
                    type: 'POST',
                    data: {
                        checkedItems: JSON.stringify(checkedItems),
                        undefinedProjectName: undefinedProjectName,
                        fromDate: fromDate,
                        undefinedcustomerName: undefinedcustomerName
                    },
                    success: function (response) {
                        ajax_Get();
                        if (response.status == "ok") {
                            message = 'Undefined Jobs were successfully added!'
                            showMessage(message, '#successText', '#successModal');
                        }
                    }
                })
                $(".btn-close").click()
                // })
            }
        })

        //search option in visibility bootstrap table
        $("#searchInput").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            // Loop through only the rows in displayedData
            $(displayedDataList).each(function () {
                var rowText = $(this).text().toLowerCase();
                var isVisible = rowText.indexOf(value) > -1;

                // Only toggle visibility for rows in displayedData
                $(this).toggle(isVisible);
            });
        });

        //Select / deselect options
        $(document).on('click', '.allselect', function () {
            $('.p_checkbox').prop('checked', $(this).prop('checked'))
        })

        $(document).on('click', '.p_checkbox', function () {
            if ($('.allselect').prop('checked') == true) {
                $('.allselect').prop('checked', false)
            }
        })

        //assignprojectModal submit
        $(document).on('click', '.projectassign_submit', function () {

            var fromDate = $("#fromdate").text();
            var ids = []
            $('.row_select input:checked').each(function () {
                id = $(this).closest('tr').attr('id')
                ids.push(id)
            })
            console.log(ids)
            let message = "If the projects you've chosen lack milestones/tasks, you'll need to create them using the task undefined button."
            showMessage(message);

            // $('.warningOkBtn').off('click');

            // $('.warningOkBtn').on('click',function(event){
            //     $('#warningModal').modal('hide')
            ajax_post({ ids: JSON.stringify(ids), fromDate: fromDate, mode: "assignproject" })
            $(".btn-close").click()
            // })
        })

        // .............................assign Milestone.............................
        // Assign Milestone
        $('#assignButton').on("click", function () {
            $.ajax({
                url: "{% url 'get_time_sheet_templete' %}",
                type: 'POST',
                data: { fromDate: $("#fromdate").text(), mode: "fetchAssignTaskData" },
                success: function (response) {
                    console.log(response)
                    let milestoneDict = response.assignedMilestonedict
                    if (response.projects.length != 0) {
                        var menuTree = $('#menu-tree');
                        console.log(response.projects)
                        // clear data from menutree
                        menuTree.empty();
                        response.projects.forEach(function (project) {
                            let quotation = project.quotation;
                            let quotationWithoutSpecialCharacters = quotation.replace(/[\/&,\s-]/g, "");

                            let projectItem = `
                            <li class="list-group-item m-1 p-0">
                                <span class="toggle" onclick="toggleChildren('project-${quotationWithoutSpecialCharacters}', this)">[+]</span>
                                <input type="checkbox" id="select-all-project-${quotationWithoutSpecialCharacters}" onclick="selectAllChildren(this)" hidden disabled>
                                <label for="select-all-project-${quotationWithoutSpecialCharacters}">
                                   ${project.customprojectName ?
                                    `${quotation} - ${project.customerName} - ${project.customprojectName}` :
                                    `${quotation} - ${project.customerName} - ${project.projectName}`
                                }
                                </label> 
                                <ul class="children list-group list-group-flush m-0" id="project-${quotationWithoutSpecialCharacters}-children" style="display: none;">
                                    ${response.phaseCategoryData.map(phase => `
                                        <li class="list-group-item m-1 p-0">
                                            <span class="toggle" onclick="toggleChildren('phase-${quotationWithoutSpecialCharacters}-${phase.phaseid}', this)">[+]</span>
                                            <input type="checkbox" id="select-all-phase-${phase.phaseid}" onclick="selectAllChildren(this)" hidden disabled>
                                            <label for="select-all-phase-${phase.phaseid}">${phase.phasename}</label>
                                            <ul class="children phaseList m-0" id="phase-${quotationWithoutSpecialCharacters}-${phase.phaseid}-children" style="display: none;">
                                                ${project.milestones.map(milestone => {
                                    // Check if milestone.milestone is in the phase.category array
                                    if (phase.categorys && phase.categorys.includes(milestone.milestone)) {
                                        return `
                                                            <li class="list-group-item m-1 p-0">
                                                                <span class="toggle" onclick="toggleChildren('milestone-${quotationWithoutSpecialCharacters}-${phase.phaseid}-${milestone.milestone}', this)">[+]</span>
                                                                <input type="checkbox" id="select-all-milestone-${milestone.milestone}" onclick="selectAllChildren(this)" hidden disabled>
                                                                <label for="select-all-milestone-${milestone.milestone}">${milestone.milestoneName}</label>
                                                                <ul class="children milestoneList m-0" id="milestone-${quotationWithoutSpecialCharacters}-${phase.phaseid}-${milestone.milestone}-children" style="display: none;">
                                                                    ${milestone.tasks.map(task => `
                                                                        <li class="m-1 p-0">
                                                                            <input type="checkbox" id="task-${task.task}" 
                                                                                quotation='${quotation}' 
                                                                                project='${project.project}' 
                                                                                customprojectName='${project.customprojectName}' 
                                                                                customerName='${project.customerName}' 
                                                                                customerCode='${project.customerCode}' 
                                                                                systemName='${project.systemName}' 
                                                                                projectName='${project.projectName}' 
                                                                                milestone='${milestone.milestone}' 
                                                                                milestoneName='${milestone.milestoneName}' 
                                                                                task='${task.task}' 
                                                                                taskName='${task.taskName}'>
                                                                            <label for="task-${task.task}">${task.taskName}</label>
                                                                        </li>
                                                                    `).join('')}
                                                                </ul>
                                                            </li>
                                                        `;
                                    } else {
                                        // If milestone.milestone is not in phase.category, return an empty string (skip rendering this milestone)
                                        return '';
                                    }
                                }).join('')}
                                            </ul>
                                        </li>
                                    `).join('')}
                                </ul>
                            </li>
                        `;
                            menuTree.append(projectItem);
                        });
                        $('#assignModal').modal("show");
                    }
                    else {
                        $('#assignModal').modal("hide");
                        var message = "Currently, there are no projects assigned!."
                        showMessage(message)
                    }
                },
                dataType: "json"
            });
        })

        // Assign Milestone submit
        $('#assignMilestoneBtn').on("click", function () {
            var fromDate = $("#fromdate").text();
            var checkedItems = [];
            // Get all selectedItems within the list
            var selectedItems = document.querySelectorAll('.milestoneList input[type="checkbox"]');

            // Loop through selectedItems
            selectedItems.forEach(function (item) {
                if (item.checked) {
                    checkedItems.push({
                        quotation_: item.getAttribute('quotation'),
                        project: parseInt(item.getAttribute('project')),
                        customprojectName: item.getAttribute('customprojectName') === 'null' ? null : item.getAttribute('customprojectName'),
                        customerName: item.getAttribute('customerName') === 'null' ? null : item.getAttribute('customerName'),
                        customerCode: item.getAttribute('customerCode') === 'null' ? null : item.getAttribute('customerCode'),
                        systemName: item.getAttribute('systemName') === 'null' ? null : item.getAttribute('systemName'),
                        projectName: item.getAttribute('projectName') === 'null' ? null : item.getAttribute('projectName'),
                        milestone: parseInt(item.getAttribute('milestone')),
                        milestoneName: item.getAttribute('milestoneName'),
                        task: parseInt(item.getAttribute('task')),
                        taskName: item.getAttribute('taskName')
                    });
                }
            });
            ajax_post({ checkedItems: JSON.stringify(checkedItems), fromDate: fromDate, mode: "assignmilestone" })
            $('#assignModal').modal("hide");
        })

        //.................................hours entry..................................

        // $(document).on('change', '.hours_', function(event) 
        // { 
        //     event.preventDefault();
        //     var quotation_id =  $(this).closest('tr').attr('quotationid');
        //     var project_id =  $(this).closest('tr').attr('projectid');
        //     var project_name =  $(this).closest('tr').attr('projectname');
        //     var milestone_id =  $(this).closest('tr').attr('milestoneid');
        //     var milestone_name =  $(this).closest('tr').attr('milestonename');
        //     var task_id =  $(this).closest('tr').attr('taskid');
        //     var task_name =  $(this).closest('tr').attr('taskname');

        //     var date =  $(this).attr('celldate');
        //     var fromDate = $("#fromdate").text();
        //     let key = $(this).val() !=''? $(this).val():'00.00';
        //     let regex = new RegExp("^[0-9.]+$");
        //     let currentCell = $(this)
        //     // Check if key is in the reg exp
        //     if(!regex.test(key)){
        //         var message = "Invalid Format"
        //         $('#errorText').text(message);
        //         $('#errorModal').modal("show");
        //         $(this).val(previousCellValue);
        //     }
        //     // check hours entry limit (lessthan 14)
        //     else {
        //         if(parseFloat(key)<=14.00){
        //             $.ajax({
        //                 url: "{% url 'get_time_sheet_templete' %}",
        //                 type:'POST', 
        //                 data:{hours:key,
        //                     quotation_id:quotation_id,
        //                     project_id:project_id,
        //                     project_name:project_name,
        //                     milestone_id:milestone_id,
        //                     milestone_name:milestone_name,
        //                     task_id:task_id,
        //                     task_name:task_name,
        //                     fromDate:fromDate,
        //                     date:date,
        //                     mode:"edithours"
        //                 },
        //                 success: function(response) {
        //                     if(response['status'] != "invalid"){
        //                         load_data(response)
        //                     }
        //                     else{
        //                         var message = 'Sorry!... \n Sum of tasks per day should be less than 14 hours.'
        //                         showMessage(message)
        //                         currentCell.val(previousCellValue)
        //                     }
        //                 }
        //             });
        //         }
        //         else 
        //         {  
        //             var message = 'Sorry!... \n Tasks hours per day should be less than 14 hours.'
        //             showMessage(message)
        //             $(this).val(previousCellValue)
        //         }
        //     }
        // });

        // get the previous value
        $(document).on('focus', '.hours_', function (event) {
            previousCellValue = $(this).val();
        })

        // update submission table by using assogn id......................
        $(document).on('change', '.hours_', function (event) {
            event.preventDefault();
            const quotation_id = $(this).closest('tr').attr('quotationid');
            const assignId = $(this).closest('tr').data('id');
            let data = ''
            var date = $(this).attr('celldate');
            var fromDate = $("#fromdate").text();
            let key = $(this).val() != '' ? $(this).val() : '00.00';
            let regex = new RegExp("^[0-9.]+$");
            let currentCell = $(this)
            // Check if key is in the reg exp
            if (!regex.test(key)) {
                var message = "Invalid Format"
                $('#errorText').text(message);
                $('#errorModal').modal("show");
                $(this).val(previousCellValue);
            }
            // check hours entry limit (lessthan 14)
            else {
                if (parseFloat(key) <= 14.00) {
                    if (quotation_id === "Non project") {
                        const milestone_id = $(this).closest('tr').attr('milestoneid');
                        const milestone_name = $(this).closest('tr').attr('milestonename');
                        const task_id = $(this).closest('tr').attr('taskid');
                        const task_name = $(this).closest('tr').attr('taskname');
                        data = {
                            hours: key,
                            milestone_id: milestone_id,
                            milestone_name: milestone_name,
                            task_id: task_id,
                            task_name: task_name,
                            fromDate: fromDate,
                            date: date,
                            mode: "edithours"
                        }
                    } else {
                        data = {
                            hours: key,
                            assignId: assignId,
                            fromDate: fromDate,
                            date: date,
                            mode: "edithours"
                        }
                    }

                    $.ajax({
                        url: "{% url 'get_time_sheet_templete' %}",
                        type: 'POST',
                        data: data,
                        success: function (response) {
                            if (response['status'] != "invalid") {
                                load_data(response)
                            }
                            else {
                                var message = 'Sorry!... \n Sum of tasks per day should be less than 14 hours.'
                                showMessage(message)
                                currentCell.val(previousCellValue)
                            }
                        }
                    });
                }
                else {
                    var message = 'Sorry!... \n Tasks hours per day should be less than 14 hours.'
                    showMessage(message)
                    $(this).val(previousCellValue)
                }
            }
        });




        // ....................Remove milestone from current timesheet...................
        // $('#projectTable').on('dblclick', 'tr:not(thead tr)', function() {   
        $('#projectTable').on('click', '.deleteIcon', function () {
            currentTimesheetStatus = $('#statusField').text();
            if (currentTimesheetStatus == '' || currentTimesheetStatus == 'Rejected' || currentTimesheetStatus == 'Unlocked') {
                const row = $(this).closest('tr');
                const rowId = row.data('id'); // Get the ID of the row
                const rowClass = row.attr('class'); // Get the class to determine the type (project/milestone/task)
                let idsToDelete = []; // Array to hold IDs to delete
                var fromDate = $("#fromdate").text();
                // Check if it's a project or milestone to delete children
                if ($(this).closest('tr').hasClass('projectRow')) {
                    // Collect all milestone IDs under this project
                    const milestoneIds = $(`.milestoneRow.projectRow-${rowId}`).map(function () {
                        return $(this).closest('tr').data('id');
                    }).get();
                    // Collect all task IDs under each milestone
                    const taskIds = milestoneIds.flatMap(milestoneId =>
                        $(`.taskRow.${rowId}-milestoneRow-${milestoneId}`).map(function () {
                            return $(this).closest('tr').data('id');
                        }).get()
                    );

                    // Add milestone IDs and task IDs to the list of IDs to delete
                    idsToDelete = idsToDelete.concat(taskIds);
                }
                else if ($(this).closest('tr').hasClass('milestoneRow')) {
                    var projectindex = rowClass.match(/projectRow-(\S+)/)
                    // Collect all task IDs under each milestone
                    const taskIds = $(`.taskRow.${projectindex[1]}-milestoneRow-${rowId}`).map(function () {
                        return $(this).closest('tr').data('id');
                    }).get()
                    idsToDelete = idsToDelete.concat(taskIds);
                }
                else {
                    idsToDelete.push(rowId);
                }
                if (idsToDelete.length == 0) {
                    // alert(noTaskQuotations[rowId])
                    idsToDelete = idsToDelete.concat(noTaskQuotations[rowId]);
                }

                let message = 'Are you sure you want to delete this item and all associated tasks?';
                showMessage(message, '#warningText', '#warningModal');
                // $('#warningText').text('Are you sure you want to delete this item and all associated data?')
                // $('#warningModal').modal('show')

                // Remove any previous click event handler for #rejectModalBtn
                $('.warningOkBtn').off('click');

                $('.warningOkBtn').on('click', function (event) {
                    $('#warningModal').modal('hide')
                    ajax_post({
                        fromDate: fromDate,
                        assignedIdList: JSON.stringify(idsToDelete),
                        mode: "removemilestone"
                    })
                    $('.btn-close').click();
                })
            }
            else {
                showMessage('Your timesheet is already ' + currentTimesheetStatus);
            }
        });

        // ..........................Duplicate..............................

        $('#duplicateButton').on("click", function () {
            if (isTableEmpty('projectTable')) {
                showMessage('No tasks has been found to extend!.');
            }
            else {
                var message = "Do you want to Extend the Tasks for next week?"
                showMessage(message, '#confirmText', '#confirmModal');
                // Remove any previous click event handler for #rejectModalBtn
                $('.confirmOkBtn').off('click');
                $('.confirmOkBtn').on('click', function (event) {
                    $('#confirmModal').modal('hide')
                    var fromDate = $("#fromdate").text();
                    ajax_post({ fromDate: fromDate, mode: "duplicate" })
                    message = 'Successfully extended the tasks for next week'
                    showMessage(message, '#successText', '#successModal');
                })
            }

        })


        // ...........................Assingn by Nmae change------------------
        $(document).on('change', '.assigners', function (e) {
            const $input = $(this);
            const closestRow = $input.closest('tr');
            const assignId = closestRow.data('id');
            const assigned_by = $input.val();

            $.ajax({
                url: "{% url 'update-assigner' %}",
                type: 'POST',
                data: {
                    assignId: JSON.stringify([assignId]),
                    assign_by: assigned_by
                },
                success: function (response) {
                    var message = 'Successfully Updated The Assigner';
                    showMessage(message, '#successText', '#successModal');
                },
                error: function (response) {
                    let errorMsg = 'Something went wrong!';
                    if (response.responseJSON && response.responseJSON.errormsg) {
                        errorMsg = response.responseJSON.errormsg;
                    }
                    showMessage(errorMsg, '#errorText', '#errorModal');
                }
            });
        });


        $('#unlock').on('click', function () {

            var message = "Are you sure you want to send request to unlock the timesheet?.";
            // $('#warningUnlockText').text(message); // Set the warning message
            // $('#warningUnlockModal').modal('show'); // Show the warning modal
            showMessage(message, '#warningUnlockText', '#warningUnlockModal')
            // Clear any previous error messages and unlock reasons
            $('#unlockModalError').text("");
            $('#unlockReason').val("");
            const fromDate = $("#fromdate").text();
            // Remove any previous click event handler for #rejectModalBtn
            $('#unlockModalBtn').off('click');

            // Bind the click event to the #rejectModalBtn
            $('#unlockModalBtn').on('click', function () {
                var reason = $('#unlockReason').val(); // Get the rejection reason from the modal input

                // Ensure that rejection reason is provided
                if (reason != "") {
                    $('#warningUnlockModal').modal('hide'); // Hide the warning modal
                    // Make the AJAX request
                    $.ajax({
                        url: "{% url 'unlock-timesheet' %}",
                        data: {
                            fromDate: fromDate,
                            reason: reason,
                        },
                        type: 'POST',
                        success: function (response) {
                            var message = "Timesheet unlock request send Successfully ...";
                            showMessage(message, '#successText', '#successModal');
                        },
                        error: function (xhr, status, error) {
                            var errorMessage = "An error occurred: " + (xhr.responseJSON?.message || xhr.statusText || "Unknown error");
                            showMessage(errorMessage, '#errorText', '#errorModal');
                        },
                        dataType: "json"
                    });
                } else {
                    showMessage("Enter a valid reason for rejection"); // Error message if missing reason
                }
            });
        });



        // .........................when status rejection reason click.................................

        $('#showRejectionReason').on("click", function () {
            var fromDate = $("#fromdate").text();
            $.ajax({
                url: "{% url 'get_time_sheet_templete' %}",
                type: 'POST',
                data: { fromDate: fromDate, mode: "rejectionReason" },
                success: function (response) {
                    $('#rejectionReasonTbl tr').not(function () { return !!$(this).has('th').length; }).remove();
                    var p = '<tbody>'
                    $.each(response.rejectedReasons, function (index, value) {
                        p += `<tr>
                        <td>`+ value['taskName'] + `</td>
                        <td>`+ value['rejection_reason'] + `</td>
                        </tr>`
                    })
                    p += '</tbody>'
                    $('#rejectionReasonTbl').append(p);
                    $('#rejectionReasonModal').modal('show');
                }
            })
        })

        // ..........................submit............................................

        $('#submitButton').on("click", function () {
            const actualHrs = $("#actualhours").text()
            const estimatedHrs = $("#estimated_hrs").text()
            if (estimatedHrs <= actualHrs) {
                var fromDate = $("#fromdate").text();
                ajax_post({ fromDate: fromDate, mode: "submit" })
                $('.btn-close').click()
            }
            else {
                var message = 'Sorry !.... \n You cannot submit your timesheet because your total hours are less than ' + estimatedHrs + ' hours.'
                $('#infoText').text(message)
                $('#infoModal').modal("show");
            }
        })

        // ..............................Load Data....................................
        function load_data(response) {
            $("#fromdate").text(response.from_date)
            $("#todate").text(response.to_date)
            // $("#currentdate").text('Date :'+response.currentdate)
            $("#currentWeek").text('Week :' + response.currentWeek)
            $("#estimated_hrs").text(response.estimated_hrs)
            $("#actualhours").text(secondsToHm(response.actual_hrs))
            noTaskQuotations = response.noTaskQuotation
            assigners = response.assigners
            // previewtable.........................................................
            $('#previewtable tr').not(function () { return !!$(this).has('th').length; }).remove();
            var p = '<tbody>'
                p+='<tr><td>Monday</td><td>'+secondsToHm(response.weekDayHrs[0])+'</td></tr>'
                p+='<tr><td>Tuesday</td><td>'+secondsToHm(response.weekDayHrs[1])+'</td></tr>'
                p+='<tr><td>Wednesday</td><td>'+secondsToHm(response.weekDayHrs[2])+'</td></tr>'
                p+='<tr><td>Thursday</td><td>'+secondsToHm(response.weekDayHrs[3])+'</td></tr>'
                p+='<tr><td>Friday</td><td>'+secondsToHm(response.weekDayHrs[4])+'</td></tr>'
                p+='<tr><td>Saturday</td><td>'+secondsToHm(response.weekDayHrs[5])+'</td></tr>'
                p+='<tr><td>Sunday</td><td>'+secondsToHm(response.weekDayHrs[6])+'</td></tr>'
                p += '</tbody>'
                p += '<tfoot><tr><td>Total</td><td class="fw-bold">' + secondsToHm(response.actual_hrs) + '</td></tr></tfoot>'
            $('#previewtable').append(p);

            // ..............................Jobs table.............................. 
            // Projects..............................................................
            $('#projectTable').empty();
            var tableHeaders = "";
            tableHeaders += '<th style="width:39dvw" class="text-start"><strong>Jobs</strong></th>';
            tableHeaders += '<th style="width:10dvw" class="text-center"><strong>Budget Owner</strong></th>';
            $.each(response.tableHeader, function (i, val) {
                tableHeaders += '<th class="text-center" style="width:6dvw"><strong>' + val + '</strong></th>';
            })
            tableHeaders += '<th style="width:3dvw"></th>';
            $('#projectTable').append('<thead class="position-sticky "><tr">' + tableHeaders + '</tr></thead>');

            var k = '<tbody>';
            if (jQuery.isEmptyObject(response.projectData)) {
                k += '<tr><td colspan="10" class="text-center text-info ">No Jobs assigned to ' + "{{request.user.first_name}} !..." + ' </td></tr>'
            }
            else {
                $.each(response.projectData, function (projectIndex, projectValue) {
                    var rowindex = projectValue["quotationId"].replace(/[\/&,\s-]/g, "");
                    var milestonerowindex = "";
                    var projectTotal = 0;

                    var jobName = projectValue['customprojectName'] != '' ?
                        projectValue['quotationId'] + ' - ' + projectValue['customerName'] + ' - ' + projectValue['customprojectName'] :
                        projectValue['projectName'] != '' ?
                            projectValue['quotationId'] + ' - ' + projectValue['customerName'] + ' - ' + projectValue['projectName'] :
                            projectValue['quotationId'];

                    k += '<tr class="projectRow parent-' + rowindex + ' " data-id=' + rowindex + '>'
                    k += '<td ><i class="fas fa-chevron-right me-2 toggleProject"></i>' + jobName + '</td>'
                    k += '<td class ="py-1 px-1"><select class="form-select form-control d-none"disabled></select></td>'
                    $.each(projectValue['workedHours'], function (dayIndex, dayValue) {
                        projectTotal += dayValue
                        k += '<td class ="py-1 px-1"><input type="text" value="' + secondsToHm(dayValue) + '" class="form-control text-center fw-bold" readonly/></td>';
                    });
                    k += '<td class ="py-1 px-1"><input type="text" value="' + secondsToHm(projectTotal) + '" class="form-control text-center fw-bold" readonly/></td>'
                    k += '<td class="text-center py-0 align-middle"><i class="bi bi-x text-danger fs-4 deleteIcon"></i></td>'
                    k += '</tr>'
                    $.each(projectValue['milestones'], function (milestoneIndex, milestoneValue) {
                        if (milestoneValue["milestoneName"] != null) {
                            milestonerowindex = milestoneValue["milestoneId"]
                            k += '<tr class="milestoneRow projectRow-' + rowindex + ' m-' + milestonerowindex + '" data-id=' + milestonerowindex + '>'
                            k += '<td class="ps-5"><i class="fas fa-chevron-right me-2 toggle"></i>' + milestoneValue['milestoneName'] + '</td>'
                            k += '<td class="py-1 px-1"colspan=9><select class="form-select form-control d-none"disabled></select></td>'
                            k += '<td class="text-center py-0 align-middle"><i class="bi bi-x text-danger fs-4 deleteIcon"></i></td>'
                            k += '</tr>'
                            $.each(milestoneValue['tasks'], function (taskIndex, taskValue) {
                                var taskTotal = 0
                                k += '<tr class="taskRow ' + rowindex + '-milestoneRow-' + milestonerowindex + '"data-id=' + taskValue['assignedId'] + ' quotationid="' + projectValue['quotationId'] +
                                    '" projectid=' + projectValue['projectId'] + ' projectname="' + projectValue['projectName'] + '" milestoneid=' + milestoneValue['milestoneId'] + ' milestonename="' +
                                    milestoneValue['milestoneName'] + '" taskid=' + taskValue['id'] + ' taskname="' + taskValue['name'] + '">'

                                k += '<td class="" style="padding-left:75px" >' + taskValue['name'] + '</td>'
                                k += '<td class ="py-1 px-1">' + buildSelectHtml(taskValue['assignBy']) + '</td>'
                                $.each(taskValue['workedHours'], function (dayIndex, dayValue) {
                                    taskTotal += dayValue
                                    k += '<td class="py-1 px-1"><input type="text" value="' + secondsToHm(dayValue) + '" class="form-control hours_ text-center ' +
                                        (secondsToHm(dayValue) != '' ? 'text-info' : '') + ' ' + isCurrentDay(dayIndex) + '" celldate="' + dayIndex + '" ' + (isdisabled(dayIndex)) + ' /></td>';
                                });
                                k += '<td class ="py-1 px-1"><input type="text" value="' + secondsToHm(taskTotal) + '" class="form-control text-center fw-bold" readonly/></td>'
                                k += '<td class="text-center py-0 align-middle"><i class="bi bi-x text-danger fs-4 deleteIcon"></i></td>'
                                k += '</tr>'
                            });
                        }
                    });
                });
            }

            k += '</tbody>';
            $('#projectTable').append(k);

            // ............................................Non projects....................................
            $('#nonProjectTable').empty()
            var tableHeaders = "";
            tableHeaders += '<th style="width:39.5dvw" class="text-start text-nowrap"><strong></i><i class="fas fa-chevron-right me-2 toggle"></i>Others</strong></th>';
            tableHeaders += '<th style="width:10dvw" class="text-start "><strong></strong></th>';
            // $.each(response.tableHeader, function(i, val){
            //     tableHeaders += '<th style="width:6dvw"></th>';
            // })
            var nonProjecthrs = 0
            $.each(response.nonProjectdata[0]['workedHours'], function (dayIndex, dayValue) {
                nonProjecthrs += dayValue
                tableHeaders += '<th class ="py-1 px-1" style="width:6dvw"><input type="text" value="' + secondsToHm(dayValue) + '" class="form-control text-center fw-bold" readonly/></th>';
            });
            tableHeaders += '<th class ="py-1 px-1" style="width:6dvw"><input type="text" value="' + secondsToHm(nonProjecthrs) + '" class="form-control text-center fw-bold" readonly/></th>'
            tableHeaders += '<th style="width:3dvw"></th>';
            $('#nonProjectTable').append('<thead class="position-sticky top-0 bg-white"><tr">' + tableHeaders + '</tr></thead>');


            var k = '<tbody>'
            $.each(response.nonProjectdata, function (nonprojectIndex, nonprojectValue) {
                $.each(nonprojectValue['milestones'], function (milestoneIndex, milestoneValue) {
                    var milestoneTotal = 0
                    k += '<tr class="milestoneRow m-' + milestoneValue["milestoneId"] + '" data-id=' + milestoneValue["milestoneId"] + '>'
                    k += '<td ><i class="fas fa-chevron-right me-2 toggle"></i>' + milestoneValue['milestoneName'] + '</td>'
                    k += '<td class ="py-1 px-1"></select></td>'
                    $.each(milestoneValue['workedHours'], function (dayIndex, dayValue) {
                        milestoneTotal += dayValue
                        k += '<td class ="py-1 px-1"><input type="text" value="' + secondsToHm(dayValue) + '" class="form-control text-center fw-bold" readonly/></td>';
                    });
                    k += '<td class ="py-1 px-1"><input type="text" value="' + secondsToHm(milestoneTotal) + '" class="form-control text-center fw-bold" readonly/></td>'
                    k += '<td class="text-center py-0 align-middle"><i class="bi bi-x fs-4 opacity-10" disabled ></i></td>'
                    k += '</tr>'
                    $.each(milestoneValue['tasks'], function (taskIndex, taskValue) {
                        var taskTotal = 0
                        k += '<tr class="taskRow milestoneRow-' + milestoneValue["milestoneId"] + '"" quotationid="' + nonprojectValue['quotationId'] + '" projectid=' + nonprojectValue['projectId'] + ' projectname="' + nonprojectValue['projectName'] + '" milestoneid=' + milestoneValue['milestoneId'] + ' milestonename="' + milestoneValue['milestoneName'] + '" taskid=' + taskValue['id'] + ' taskname="' + taskValue['name'] + '">'
                        k += '<td class="ps-5" >' + taskValue['name'] + '</td>'
                        k += '<td class ="py-1 px-1"></select></td>'
                        $.each(taskValue['workedHours'], function (dayIndex, dayValue) {
                            taskTotal += dayValue
                            k += '<td class ="py-1 px-1"><input type="text" value="' + secondsToHm(dayValue) + (secondsToHm(dayValue) != '' ? '"class="form-control hours_ text-center text-info"' : '"class="form-control hours_ text-center"') + '" celldate=' + dayIndex + ' /></td>';
                        });
                        k += '<td class ="py-1 px-1"><input type="text" value="' + secondsToHm(taskTotal) + '" class="form-control text-center fw-bold" readonly/></td>'
                        k += '<td class="text-center py-0 align-middle"><i class="bi bi-x fs-4 opacity-10" disabled></i></td>'
                        k += '</tr>'
                    });
                });
            });

            k += '</tbody>';

            $('#nonProjectTable').append(k);
            $('#nonProjectTable tbody').hide();

            // colapse all projectrow and nonprojectrow
            hideAllProjectRow();

            hideAllNonProjectTasks();

            // expanded rows displaying when reloading table
            expandedRows.projectRows.forEach(parentId => {
                showProject(parentId)
            });

            expandedRows.milestoneRows.forEach(childId => {
                if (expandedRows.projectRows.size != 0) {
                    showMileStone(childId, Array.from(expandedRows.projectRows)[0])
                    $('#nonProjectTable tbody').hide();
                }
                else {
                    showNoneProjectMileStone(childId)
                    $('#projectTable tbody').hide();
                    $('#nonProjectTable tbody').show();
                }
            });

            // timesheetstatus.....................................................
            const status = response.timesheetStatus;

            if (status === null || status === undefined) {
                $("#statusField").text("");
                $("#statusDiv").hide();
                updateButtonDisableState(false, 'bg-secondary', 'bg-info');
            } else {
                $("#statusDiv").show();
                $("#showRejectionReason").hide(); // Default hide

                switch (status) {
                    case 'Rejected':
                        $("#statusField").text("Rejected").css("color", "#FF0000");
                        $("#showRejectionReason").show();
                        $(".hours_").prop('disabled', false);
                        updateButtonDisableState(false, 'bg-secondary', 'bg-info');
                        break;

                    case 'Unlocked':
                        $("#statusField").text("Unlocked").css("color", "#000000");
                        $(".hours_").prop('disabled', false);
                        updateButtonDisableState(false, 'bg-secondary', 'bg-info');
                        break;
                    case 'locked':
                        $("#statusField").text("Awaiting Unlock").css("color", "#000000");
                        //$(".hours_").prop('disabled', true);
                        updateButtonDisableState(false, 'bg-secondary', 'bg-info');
                        $('#submitButton').prop("disabled",true).removeClass('bg-info').addClass('bg-secondary');
                        break;

                    case 'Submitted':
                        $("#statusField").text("Submitted").css("color", "#0000FF");
                        $(".hours_").prop('disabled', true);
                        updateButtonDisableState(true, 'bg-info', 'bg-secondary');
                        break;

                    case 'Accepted':
                        $("#statusField").text("Accepted").css("color", "#00FF00");
                        $(".hours_").prop('disabled', true);
                        updateButtonDisableState(true, 'bg-info', 'bg-secondary');
                        break;

                    default:
                        // Handle unknown statuses
                        $("#statusField").text(status).css("color", "#000000");
                        $(".hours_").prop('disabled', false);
                        updateButtonDisableState(false, 'bg-secondary', 'bg-info');
                }
            }

        }

        //............toggle tbody 
        $(document).on('click', '#projectTable thead,#nonProjectTable thead', function () {
            // Check which table header was clicked
            const tableId = $(this).closest('table').attr('id');

            // Hide both tables' bodies first
            // $('tbody').hide();
            $('#projectTable tbody,#nonProjectTable tbody').hide();

            // Show the corresponding table body based on the clicked header
            if (tableId === 'projectTable') {
                $('#projectTable tbody').show();
            } else if (tableId === 'nonProjectTable') {
                $('#nonProjectTable tbody').show();
            }
        });
    })
    $('.cancelButton').on("click", function () {
        $('#warningModal').modal('hide');
        $('#infoModal').modal('hide');
        $('#warningRejectionModal').modal('hide');
        $('#successModal').modal('hide')
        $('#errorModal').modal('hide')
        $('#warningUnlockModal').modal('hide');
    })
    function buildSelectHtml(assign_by = 0) {
        const options = assigners.map(assigner => {
            const selected = assigner.id === assign_by ? 'selected' : '';
            return `<option value="${assigner.id}" ${selected}>${assigner.first_name}</option>`;
        }).join('');

        return `<select class="form-select form-control assigners">${options}</select>`;
    }


    // button disable / enable when these conditions like submitted,accepted,notsubmitted,rejected
    function updateButtonDisableState(isDisabled, removeClass, addClass) {
        $('#jobAssignButton').prop("disabled", isDisabled).removeClass(removeClass).addClass(addClass);
        $('#ServicesassignButton').prop("disabled", isDisabled).removeClass(removeClass).addClass(addClass);
        $('#assignButton').prop("disabled", isDisabled).removeClass(removeClass).addClass(addClass);
        $('#submitButton').prop("disabled", isDisabled).removeClass(removeClass).addClass(addClass);
    }

    // Hide all rows first  
    function hideAllProjectRow() {
        $('#projectTable .projectRow').each(function () {
            $(this).nextUntil('.projectRow').hide();
            if ($(this).find(".toggleProject").attr('class').match(/fa-chevron-down/)) {
                $(this).find(".toggleProject").toggleClass('fa-chevron-right fa-chevron-down');
            }
        })
    }

    // Hide all Non-Project Tasks
    function hideAllNonProjectTasks() {
        // colapse all milestone first in Nonproject Table
        $('#nonProjectTable .milestoneRow').each(function () {
            $(this).nextUntil('.milestoneRow').hide();
            if ($(this).find(".toggle").attr('class').match(/fa-chevron-down/)) {
                $(this).find(".toggle").toggleClass('fa-chevron-right fa-chevron-down');
            }
        })
    }

    // Expand Projects
    function showProject(id) {

        const childRows = $(`.projectRow-${id}`);

        $(`#projectTable .parent-${id}`).nextUntil('.projectRow').show();
        // Hide all child and grandchild rows under this parent
        for (let i = 0; i < childRows.length; i++) {
            const childRow = childRows[i];
            const childId = $(childRow).data('id');
            $(`.${id}-milestoneRow-${childId}`).hide();
        }
        $(`#projectTable .parent-${id}`).find(".toggleProject").toggleClass('fa-chevron-right fa-chevron-down')
    }

    function showMileStone(id, parentId) {
        $(`#projectTable .${parentId}-milestoneRow-${id}`).show();
        $(`#projectTable .projectRow-${parentId}.m-${id}`).find(".toggle").toggleClass('fa-chevron-right fa-chevron-down')
    }

    function showNoneProjectMileStone(id) {
        $(`#nonProjectTable .milestoneRow-${id}`).show();
        $(`#nonProjectTable .m-${id}`).find(".toggle").toggleClass('fa-chevron-right fa-chevron-down')
    }

    // for toggling project row
    $('#projectTable').on("click", "tr .toggleProject ", function () {

        event.preventDefault();
        hideAllNonProjectTasks();
        const parentId = $(this).closest('tr').data('id');
        const childRows = $(`.projectRow-${parentId}`);
        // Hide all child and grandchild rows under this parent
        for (let i = 0; i < childRows.length; i++) {
            const childRow = childRows[i];
            const childId = $(childRow).data('id');
            $(`.${parentId}-milestoneRow-${childId}`).hide();
            if ($(`.projectRow-${parentId}.m-${childId}`).find(".toggle").attr('class').match(/fa-chevron-down/)) {
                $(`.projectRow-${parentId}.m-${childId}`).find(".toggle").toggleClass('fa-chevron-right fa-chevron-down');
            }
        }

        childRows.toggle();
        if (childRows.find(".toggle").attr('class').match(/fa-chevron-down/)) {
            childRows.find(".toggle").toggleClass('fa-chevron-right fa-chevron-down');
        }

        const siblingRows = $('.projectRow').map(function () {
            return $(this).data('id');
        }).get();
        for (let i = 0; i < siblingRows.length; i++) {
            const siblingId = siblingRows[i];
            if (siblingId !== parentId) {
                const siblingChildRows = $(`.projectRow-${siblingId}`);
                // Hide all child and grandchild rows under this parent
                for (let i = 0; i < siblingChildRows.length; i++) {
                    const siblingChildRow = siblingChildRows[i];
                    const siblingChildId = $(siblingChildRow).data('id');
                    $(`.${siblingId}-milestoneRow-${siblingChildId}`).hide();
                }
                $(`.projectRow-${siblingId}`).hide();
                if ($(`.parent-${siblingId}`).find(".toggleProject").hasClass('fa-chevron-down')) {
                    $(`.parent-${siblingId}`).find(".toggleProject").toggleClass('fa-chevron-right fa-chevron-down');
                }
            }
        }

        // Update expanded state
        if (childRows.is(':visible')) {
            expandedRows.milestoneRows.clear();
            expandedRows.projectRows.clear();
            expandedRows.projectRows.add(parentId);
        } else {
            expandedRows.projectRows.delete(parentId);
            childRows.each(function () {
                const childId = $(this).data('id');
                expandedRows.milestoneRows.delete(childId);
            });
        }
        $(this).toggleClass('fa-chevron-right fa-chevron-down');
    });

    // for toggling milestone row
    $('#projectTable').on("click", "tr .toggle", function () {
        const childId = $(this).closest('tr').data('id');
        const parentId = $(this).closest('tr').attr('class').match(/projectRow-([\w-]+)/)[1];

        // Hide all sibling child rows and their grandchild rows
        const siblingChildRows = $(`.projectRow-${parentId}`);
        for (let i = 0; i < siblingChildRows.length; i++) {
            const siblingChildRow = siblingChildRows[i];
            const siblingChildId = $(siblingChildRow).data('id');
            if (siblingChildId !== childId) {
                $(`.${parentId}-milestoneRow-${siblingChildId}`).hide();
                if ($(`.projectRow-${parentId}.m-${siblingChildId}`).find(".toggle").attr('class').match(/fa-chevron-down/)) {
                    $(`.projectRow-${parentId}.m-${siblingChildId}`).find(".toggle").toggleClass('fa-chevron-right fa-chevron-down');
                }
            }
        }

        // Toggle grandchild rows for the clicked child row
        $(`.${parentId}-milestoneRow-${childId}`).toggle();

        // Update expanded state
        if ($(`.${parentId}-milestoneRow-${childId}`).is(':visible')) {
            expandedRows.milestoneRows.clear();
            expandedRows.milestoneRows.add(childId);
        } else {
            expandedRows.milestoneRows.delete(childId);
        }
        $(this).toggleClass('fa-chevron-right fa-chevron-down');
    });

    // Toggle for None project milestone
    $('#nonProjectTable').on("click", "tr .toggle", function () {
        hideAllProjectRow();
        expandedRows.projectRows.clear();
        const milestoneId = $(this).closest('tr').data('id');

        const siblingRows = $(`.milestoneRow`);
        for (let i = 0; i < siblingRows.length; i++) {
            const siblingRow = siblingRows[i];
            const siblingId = $(siblingRow).data('id');
            if (siblingId !== milestoneId) {
                $(`.milestoneRow-${siblingId}`).hide();
                // console.log($(`.milestoneRow[data-id=${siblingId}]`))
                if ($(`.m-${siblingId}`).find(".toggle").attr('class').match(/fa-chevron-down/)) {
                    $(`.m-${siblingId}`).find(".toggle").toggleClass('fa-chevron-right fa-chevron-down');
                }
            }
        }

        // Toggle grandchild rows for the clicked child row
        $(`.milestoneRow-${milestoneId}`).toggle();
        // Update expanded state
        if ($(`.milestoneRow-${milestoneId}`).is(':visible')) {
            expandedRows.milestoneRows.clear();
            expandedRows.milestoneRows.add(milestoneId);
        } else {
            expandedRows.milestoneRows.delete(milestoneId);
        }
        $(this).toggleClass('fa-chevron-right fa-chevron-down');
    });

    // Toggle for others table
    $('#othersTogle').on("click", function () {
        $("#nonProjectTable").toggle();
    })

    // Modal close
    $('.cancelButton').on("click", function () {
        $('#infoModal').modal('hide');
        $('#errorModal').modal('hide');
        $('#successModal').modal('hide');
        $('#warningModal').modal('hide');
        $('#confirmModal').modal('hide')

        // other modals
        $('#rejectionReasonModal').modal('hide');
        $('#assignModal').modal('hide');
    })

    // other modals
    $('.modalCancelButton').on("click", function () {
        $('#projectassignModal').modal('hide');
        $('#serviceAssignModal').modal('hide');
    })

    function showMessage(message, textbox = '#infoText', modalid = '#infoModal') {
        // Display message in the textbox
        $(textbox).text(message);

        // Show the modal
        $(modalid).modal("show");
    }

    // only currentday and previousday will enable
    function isCurrentDay(date) {
        const currentDay = new Date();

        var parts = date.split('-');
        var formattedDate = parts[2] + '-' + parts[1] + '-' + parts[0];
        const cellDate = new Date(formattedDate);
        if (cellDate.toDateString() === currentDay.toDateString()) {
            return "border-primary"
        }
        else {
            return ""
        }
    }

    // only currentday and previousday will enable
    function isdisabled(date) {
        const currentDay = new Date();
        const PreviousDay = new Date();
        PreviousDay.setDate(currentDay.getDate() - 1);

        const tomorrow = new Date();
        tomorrow.setDate(currentDay.getDate() + 1); // Day before yesterday

        var parts = date.split('-');
        var formattedDate = parts[2] + '-' + parts[1] + '-' + parts[0];
        const cellDate = new Date(formattedDate);
        if (cellDate.toDateString() === currentDay.toDateString() || cellDate.toDateString() === PreviousDay.toDateString() || cellDate.toDateString() === tomorrow.toDateString()) {
            return ""
        }
        else {
            return "disabled"
        }
    }

    // hours convertion
    function convertToSeconds(hours = 0, minutes = 0) {
        return (
            Number(hours) * 60 * 60 +
            Number(minutes) * 60
        );
    }

    function secondsToHm(seconds) {
        if (seconds != 0) {
            sec = Number(seconds);
            var h = Math.floor(sec / 3600);
            var m = Math.floor(sec % 3600 / 60);
            return h.toString().padStart(2, '0') + '.' + m.toString().padStart(2, '0');
        }
        else {
            return ''
        }
    }

    // assign task model toggle and select
    function toggleChildren(id, toggleElement) {
        var childrenList = $(`#${id}-children`);
        if (childrenList.is(':hidden')) {
            childrenList.show();
            $(toggleElement).text('[-]');
        } else {
            childrenList.hide();
            $(toggleElement).text('[+]');
        }
    }

    function selectAllChildren(checkbox) {
        var childrenList = $(checkbox).closest('li').find('.children');
        childrenList.find('input[type="checkbox"]').prop('checked', checkbox.checked);
    }

    function isTableEmpty(tableId) {
        var table = document.getElementById(tableId);
        // Check if there are any rows except for the header row (index 0)
        return table.rows.length <= 2;
    }
</script>

<script src="{% static 'js/select2.min.js.js'%}"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>

{% endblock %}